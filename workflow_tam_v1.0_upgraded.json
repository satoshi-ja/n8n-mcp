{
  "name": "tam版_カフェメニューをslackに自動投稿 v1.0 (v1.1機能追加版)",
  "nodes": [
    {
      "parameters": {
        "path": "cafe-menu-form-webhook",
        "formTitle": "カフェメニュー告知フォーム",
        "formDescription": "写真とメニュー名を入力するだけで、プロ級のカフェ告知が瞬時に完成！",
        "formFields": {
          "values": [
            {
              "fieldLabel": "メニュー名",
              "requiredField": true
            },
            {
              "fieldLabel": "カテゴリ",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {"option": "コーヒー ☕"},
                  {"option": "ドリンク🍹"},
                  {"option": "スイーツ 🧁"},
                  {"option": "ランチ🍝"},
                  {"option": "BAR🍺"}
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "写真",
              "fieldType": "file",
              "multipleFiles": false,
              "acceptFileTypes": ".jpg,.jpeg,.png",
              "requiredField": true
            },
            {
              "fieldLabel": "場所",
              "requiredField": true
            },
            {
              "fieldLabel": "提供時間",
              "requiredField": true
            },
            {
              "fieldLabel": "特別な説明",
              "fieldType": "textarea",
              "requiredField": "={{ false }}"
            }
          ]
        },
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "form-trigger",
      "name": "Form Trigger",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.1,
      "position": [0, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-3-5-sonnet-20241022\",\n  \"max_tokens\": 300,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": \"この画像を見て、料理や飲み物の特徴を詳しく説明してください。色合い、盛り付け、雰囲気などを含めて、魅力的に描写してください。\"\n        },\n        {\n          \"type\": \"image\",\n          \"source\": {\n            \"type\": \"base64\",\n            \"media_type\": \"{{ $binary.data.mimeType }}\",\n            \"data\": \"{{ $binary.data.data }}\"\n          }\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "id": "image-analysis",
      "name": "画像解析 (Claude Vision)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [400, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-3-5-sonnet-20241022\",\n  \"max_tokens\": 100,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": \"{{ $('Form Trigger').item.json.メニュー名 }}という{{ $('Form Trigger').item.json.カテゴリ }}の料理について、カフェの宣伝用に魅力的で短いキャッチフレーズを一つだけ作ってください。前置きや説明は不要で、キャッチフレーズのみを返してください。\\n\\n画像分析結果：{{ $('画像解析 (Claude Vision)').item.json.content[0].text }}\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "catchphrase-generation",
      "name": "キャッチフレーズ生成",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [608, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"claude-3-5-sonnet-20241022\",\n  \"max_tokens\": 200,\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": \"カフェのSlack告知用に、{{ $('Form Trigger').item.json.メニュー名 }}についての魅力的な説明文を2〜3文で作成してください。購買意欲をそそるような内容でお願いします。\\n\\nメニュー名：{{ $('Form Trigger').item.json.メニュー名 }}\\nカテゴリ：{{ $('Form Trigger').item.json.カテゴリ }}\\n画像分析：{{ $('画像解析 (Claude Vision)').item.json.content[0].text }}\\nキャッチフレーズ：{{ $('キャッチフレーズ生成').item.json.content[0].text }}\\n{{ $('Form Trigger').item.json.特別な説明 ? '特別な説明：' + $('Form Trigger').item.json.特別な説明 : '' }}\\n\\n前置きや説明は不要で、説明文のみを返してください。\"\n    }\n  ]\n}",
        "options": {}
      },
      "id": "description-generation",
      "name": "説明文生成",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [800, 0]
    },
    {
      "parameters": {
        "jsCode": "// デバッグ: すべてのバイナリデータを確認\n  console.log('=== BINARY DATA DEBUG ===');\n  console.log('Form Trigger binary:', $('Form Trigger').item.binary);\n  console.log('Form Trigger binary keys:', $('Form Trigger').item.binary ? Object.keys($('Form Trigger').item.binary) :\n  'No binary');\n  console.log('Input binary:', $input.item.binary);\n  console.log('Input binary keys:', $input.item.binary ? Object.keys($input.item.binary) : 'No binary');\n\n  // フォームデータの取得\n  const formData = $('Form Trigger').item.json;\n\n  // 各ノードからデータを安全に取得（存在しない場合はデフォルト値を使用）\n  let imageAnalysis = \"美味しそうな料理の写真です。\";\n  let catchphrase = \"本日のおすすめメニュー\";\n  let description = \"ぜひお試しください。\";\n\n  // 画像解析が有効な場合\n  try {\n    const imageAnalysisNode = $('画像解析 (Claude Vision)');\n    if (imageAnalysisNode && imageAnalysisNode.item && imageAnalysisNode.item.json) {\n      imageAnalysis = imageAnalysisNode.item.json.content[0].text;\n    }\n  } catch (e) {\n    console.log('画像解析ノードが無効またはエラー:', e.message);\n  }\n\n  // キャッチフレーズ生成の結果を取得\n  try {\n    const catchphraseNode = $('キャッチフレーズ生成');\n    if (catchphraseNode && catchphraseNode.item && catchphraseNode.item.json) {\n      catchphrase = catchphraseNode.item.json.content[0].text;\n    }\n  } catch (e) {\n    console.log('キャッチフレーズ生成ノードのエラー:', e.message);\n  }\n\n  // 説明文生成の結果を取得\n  try {\n    const descriptionNode = $('説明文生成');\n    if (descriptionNode && descriptionNode.item && descriptionNode.item.json) {\n      description = descriptionNode.item.json.content[0].text;\n    }\n  } catch (e) {\n    console.log('説明文生成ノードのエラー:', e.message);\n  }\n\n  // カテゴリに応じた装飾の選択\n  let decoration = {};\n  switch(formData.カテゴリ) {\n    case 'コーヒー ☕':\n      decoration = {\n        mainEmoji: '☕',\n        subEmojis: ['✨', '⭐'],\n        borderStyle: '━━━━━━━━━━━━━━━━━━━━'\n      };\n      break;\n    case 'ドリンク🍹':\n      decoration = {\n        mainEmoji: '🍹',\n        subEmojis: ['🌴', '🌊'],\n        borderStyle: '〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜'\n      };\n      break;\n    case 'スイーツ 🧁':\n      decoration = {\n        mainEmoji: '🧁',\n        subEmojis: ['🎉', '💕'],\n        borderStyle: '🌈 ═══════════════ 🌈'\n      };\n      break;\n    case 'ランチ🍝':\n      decoration = {\n        mainEmoji: '🍝',\n        subEmojis: ['🌿', '🥗'],\n        borderStyle: '◆◇◆◇◆◇◆◇◆◇◆◇◆◇◆'\n      };\n      break;\n    case 'BAR🍺':\n      decoration = {\n        mainEmoji: '🍺',\n        subEmojis: ['🎆', '🌙'],\n        borderStyle: '★☆★☆★☆★☆★☆★☆★'\n      };\n      break;\n    default:\n      decoration = {\n        mainEmoji: '🍴',\n        subEmojis: ['✨', '⭐'],\n        borderStyle: '━━━━━━━━━━━━━━━━━━━━'\n      };\n  }\n\n  // 現在時刻の取得\n  const now = new Date();\n  const hours = now.getHours();\n  let timeGreeting = '';\n  if (hours < 12) {\n    timeGreeting = 'おはようございます！朝の';\n  } else if (hours < 17) {\n    timeGreeting = 'こんにちは！午後の';\n  } else {\n    timeGreeting = 'お疲れ様です！夕方の';\n  }\n\n  // Slack投稿メッセージの組み立て (Slackのマークアップ形式)\n  const slackMessage = `\n  ┌─────────────────────┐\n  │  ${decoration.mainEmoji} 本日のSpecial ${decoration.mainEmoji}  │\n  └─────────────────────┘\n\n  ${decoration.subEmojis[0]} *${catchphrase}* ${decoration.subEmojis[0]}\n\n  ${description}\n\n  ${decoration.borderStyle}\n  📍 場所: ${formData.場所}\n  ⏰ 提供時間: ${formData.提供時間}\n  ${decoration.borderStyle}\n\n  🎯 ${timeGreeting}ひととき、\n  ${decoration.mainEmoji} でほっと一息つきませんか？\n\n  #tam and co. #今日のオススメ #${formData.カテゴリ.replace(' ', '')}\n  `;\n\n  // Form Triggerから直接バイナリデータを取得\n  const originalBinary = $('Form Trigger').item.binary;\n\n  // バイナリデータのキー名を統一（重要！）\n  let normalizedBinary = {};\n  if (originalBinary && Object.keys(originalBinary).length > 0) {\n    const firstKey = Object.keys(originalBinary)[0];\n    console.log('Original binary key:', firstKey);\n    normalizedBinary = { data: originalBinary[firstKey] };\n  } else if ($input.item.binary && Object.keys($input.item.binary).length > 0) {\n    const firstKey = Object.keys($input.item.binary)[0];\n    console.log('Input binary key:', firstKey);\n    normalizedBinary = { data: $input.item.binary[firstKey] };\n  }\n\n  console.log('Normalized binary:', normalizedBinary);\n\n  // 結果を返す（バイナリデータも含める）\n  return {\n    json: {\n      slackMessage: slackMessage,\n      menuName: formData.メニュー名,\n      category: formData.カテゴリ,\n      decoration: decoration\n    },\n    // バイナリデータを'data'というキー名で確実に渡す\n    binary: normalizedBinary\n  };"
      },
      "id": "slack-post-builder",
      "name": "Slack投稿構築",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1008, 0]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C096CHYL9U2",
          "mode": "list",
          "cachedResultName": "tam-and-co"
        },
        "text": "={{ $json.slackMessage }}",
        "otherOptions": {}
      },
      "id": "slack-post",
      "name": "Slack投稿",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1200, 0]
    },
    {
      "parameters": {
        "resource": "file",
        "options": {
          "channelId": "C096CHYL9U2",
          "binaryPropertyName": "data"
        }
      },
      "id": "photo-upload",
      "name": "写真アップロード",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1200, 208],
      "continueOnFail": true
    }
  ],
  "connections": {
    "Form Trigger": {
      "main": [
        [
          {
            "node": "画像解析 (Claude Vision)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "画像解析 (Claude Vision)": {
      "main": [
        [
          {
            "node": "キャッチフレーズ生成",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "キャッチフレーズ生成": {
      "main": [
        [
          {
            "node": "説明文生成",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "説明文生成": {
      "main": [
        [
          {
            "node": "Slack投稿構築",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack投稿構築": {
      "main": [
        [
          {
            "node": "Slack投稿",
            "type": "main",
            "index": 0
          },
          {
            "node": "写真アップロード",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}